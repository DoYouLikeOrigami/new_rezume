"use strict";var mainModule=function(){var t=function(){},e=function(){mainTopperModule.init(),showTextModule.init(".js--show-about-text",".section-about__text","section-about__text--mobile-visible"),showTextModule.initMultiple(".section-exp",".js--show-text",".section-exp__item-descr","section-exp__item-descr--mobile-visible","Показать описание"),mobileNavModule.init(),projectPopupModule.init();var t=document.querySelector(".js--main-scroll")||!1;if(t){var e=t.getAttribute("href");scrollModule.bindScroll(t,e)}};return{init:function(){t(),e()}}}(),mainTopperModule=function(){var e={activeClass:"main-topper--visible",mainTopper:document.querySelector(".main-topper")||!1,linksSelector:".main-topper__nav ul li a"},t=function(){o(),s()},i=function(){},o=function(){window.addEventListener("scroll",function(){var t=parseInt(window.pageYOffset||document.documentElement.scrollTop);e.mainTopper.clientHeight<=t?e.mainTopper.classList.add(e.activeClass):e.mainTopper.classList.remove(e.activeClass)})},s=function(){for(var o=e.mainTopper.querySelectorAll(e.linksSelector),t=0;t<o.length;t++)!function(i){o[i].addEventListener("click",function(t){t.preventDefault();var e=o[i].getAttribute("href");scrollModule.scrollTo(e)})}(t)};return{init:function(){e.mainTopper&&(t(),i())}}}(),mobileNavModule=function(){var i={mobileNavButtonSelector:".js-show-mobile-nav",hideNavSelector:".js-hide-mobile-nav",mobileNavSelector:".mobile-nav",mobileNavHiddenClass:"mobile-nav--hidden",overlay:document.querySelector(".block-overlay")||!1,overlayActiveClass:"block-overlay--active",linksSelector:".mobile-nav__link"},t=function(){o(document.querySelectorAll(i.mobileNavButtonSelector)),s(),r(),l()},e=function(){},o=function(t){if(!t)return console.error("mobileNavModule -> _bindMobileNav : no navBtn found or passed: "+t),!1;for(var e=0;e<t.length;e++)t[e].addEventListener("click",function(t){t.preventDefault(),n()});return!0},s=function(){i.overlay&&i.overlay.addEventListener("click",function(t){t.preventDefault,a()})},r=function(){if(i.hideNavSelector)for(var t=document.querySelectorAll(i.hideNavSelector),e=0;e<t.length;e++)t[e].addEventListener("click",function(t){t.preventDefault(),a()})},n=function(){var t=document.querySelector(i.mobileNavSelector);return t&&(t.classList.remove(i.mobileNavHiddenClass),i.overlay&&i.overlay.classList.add(i.overlayActiveClass)),!0},a=function(){var t=document.querySelector(i.mobileNavSelector);return t&&(t.classList.add(i.mobileNavHiddenClass),i.overlay&&i.overlay.classList.remove(i.overlayActiveClass)),!0},l=function(){var t=document.querySelector(i.mobileNavSelector);if(!t)return!1;for(var o=t.querySelectorAll(i.linksSelector),e=0;e<o.length;e++)!function(i){o[i].addEventListener("click",function(t){t.preventDefault();var e=o[i].getAttribute("href");a(),scrollModule.scrollTo(e)})}(e)};return{init:function(){t(),e()},show:function(){return n()},hide:function(){return a()}}}(),projectPopupModule=function(){var a={btnShowSelector:".js--show-project-popup",btnHideSelector:".js--hide-project-popup",popupSelector:".block-project-popup",popupActiveClass:"block-project-popup--active",iframeSelector:".block-project-popup__iframe",githubLinkSelector:".block-project-popup__controls-link",preloader:document.querySelector(".block-preloader")||!1,preloaderVisibleClass:"block-preloader--visible"},t=function(){e(),i()},e=function(){for(var n=document.querySelectorAll(a.btnShowSelector),t=0;t<n.length;t++)!function(t){var e=document.querySelector(a.popupSelector),i=n[t].dataset.src,o=n[t].getAttribute("href"),s=e.querySelector(a.iframeSelector),r=e.querySelector(a.githubLinkSelector);n[t].addEventListener("click",function(t){t.preventDefault(),e&&(mobileNavModule.hide(),s.setAttribute("src",i),r.setAttribute("href",o),a.preloader&&a.preloader.classList.add(a.preloaderVisibleClass),s.onload=function(){e.classList.add(a.popupActiveClass),a.preloader&&a.preloader.classList.remove(a.preloaderVisibleClass)})})}(t)},i=function(){for(var t=document.querySelectorAll(a.btnHideSelector),e=0;e<t.length;e++)t[e].addEventListener("click",function(t){t.preventDefault(),o()})},o=function(){var t=document.querySelector(a.popupSelector);t&&t.classList.remove(a.popupActiveClass)};return{init:function(){t()},hide:o}}(),scrollModule=function(){var s={topper:document.querySelector(".main-topper")||!1},i=function(t){var e=document.querySelector(t),i=0,o=0;if(!e)return console.error("Error in scrollModule -> scrollTo : no item found by selector "+t),!1;s.topper&&"none"!=s.topper.style.display&&(i=s.topper.clientHeight),(o=e.offsetTop+i)<0&&(o=0),window.scroll({top:o,left:0,behavior:"smooth"})};return{scrollTo:i,bindScroll:function(t,e){if(!t||!e)return console.error("Error in scrollModule -> bindScroll : no element or selector passed"),!1;t.addEventListener("click",function(t){t.preventDefault(),i(e)})}}}(),showTextModule=function(){var h=function(e,i,o,t){if(!e||!i||!o)return console.error("Error in showTextModule -> _bind : no btn, textBlock or textActiveClass found"),!1;var s=t||"Читать далее";e.addEventListener("click",function(t){t.preventDefault(),i.classList.contains(o)?e.innerText=s:e.innerText="Скрыть текст",i.classList.toggle(o)})},a=function(t,e,i,o,s){if(!t||!o)return console.error("Error in showTextModule -> _bindAll : no block or textActiveClass found"),!1;var r,n=t.querySelectorAll(e),a=t.querySelectorAll(i);if(!n||!a)return console.error("Error in showTextModule -> _bindAll : no btns or texts found"),!1;for(var l=0;l<n.length;l++)h(n[r=l],a[r],o,s)};return{init:function(t,e,i,o){var s=document.querySelector(t),r=document.querySelector(e);h(s,r,i,o)},initMultiple:function(t,e,i,o,s){for(var r=document.querySelectorAll(t),n=0;n<r.length;n++)a(r[n],e,i,o,s)}}}();function Camera(t,e,i){this.x=0,this.y=0,this.init(t,e,i)}Camera.prototype.init=function(t,e,i){this.width=e,this.height=i,this.maxX=t.cols*t.tsize-e,this.maxY=t.rows*t.tsize-i},Camera.prototype.follow=function(t){(this.following=t).screenX=0,t.screenY=0},Camera.prototype.update=function(){this.following.screenX=this.width/2,this.following.screenY=this.height/2,this.x=this.following.x-this.width/2,this.y=this.following.y-this.height/2,this.x=Math.max(0,Math.min(this.x,this.maxX)),this.y=Math.max(0,Math.min(this.y,this.maxY)),(this.following.x<this.width/2||this.following.x>this.maxX+this.width/2)&&(this.following.screenX=this.following.x-this.x),(this.following.y<this.height/2||this.following.y>this.maxY+this.height/2)&&(this.following.screenY=this.following.y-this.y)};var Game={};function Hero(t,e,i){this.map=t,this.x=e,this.y=i,this.width=t.tsize,this.height=t.tsize,this.image=Loader.getImage("hero"),this.targets=this.map.getTargets(),this.closestTarget=this._getClosestTarget(),this.targetsAchieved=0,this.handMode=!1,this._bindHandModeBtn()}Game.run=function(t,e){this.container=t,this.canvas=e,this.ctx=this.canvas.getContext("2d"),this._resizeCanvas(),this._previousElapsed=0;var i=this.load();Promise.all(i).then(function(t){this.init(),window.requestAnimationFrame(this.tick)}.bind(this))},Game.tick=function(t){window.requestAnimationFrame(this.tick),this.ctx.clearRect(0,0,this.ctxW,this.ctxH);var e=(t-this._previousElapsed)/1e3;e=Math.min(e,.25),this._previousElapsed=t,this.update(e),this.render()}.bind(Game),Game.load=function(){return[Loader.loadImage("tiles","../assets/tiles.png"),Loader.loadImage("hero","../assets/character.png")]},Game.init=function(){var t;Keyboard.listenForEvents([Keyboard.LEFT,Keyboard.RIGHT,Keyboard.UP,Keyboard.DOWN]),this.tileAtlas=Loader.getImage("tiles"),this.hero=new Hero(map,160,160),this.camera=new Camera(map,this.ctxW,this.ctxH),this.camera.follow(this.hero),this.ctx.font="18px Raleway",t=this,window.addEventListener("resize",function(){t._resizeCanvas()})},Game.update=function(t){this.hero.update(t,this.camera.following.screenX,this.camera.following.screenY),this.camera.update()},Game.render=function(){this._drawLayer({tile:3}),this._drawLayer({tile:4}),this._drawLayer({layer:0}),this.ctx.drawImage(this.hero.image,this.hero.screenX-this.hero.width/2,this.hero.screenY-this.hero.height/2),this._drawLayer({layer:1}),this.ctx.fillText("Собрано кустов: "+this.hero.targetsAchieved,20,30)},Game._resizeCanvas=function(){var t=this.container.clientWidth-this.container.clientWidth%map.tsize,e=this.container.clientHeight-this.container.clientHeight%map.tsize;this.canvas.setAttribute("width",t),this.canvas.setAttribute("height",e),this.ctxW=t,this.ctxH=e,"camera"in this&&this.camera.init(map,t,e)},Game._drawLayer=function(t){for(var e=Math.floor(this.camera.x/map.tsize),i=e+this.camera.width/map.tsize,o=Math.floor(this.camera.y/map.tsize),s=o+this.camera.height/map.tsize,r=-this.camera.x+e*map.tsize,n=-this.camera.y+o*map.tsize,a=e;a<=i;a++)for(var l=o;l<=s;l++){var h;"layer"in t?h=map.getTile(t.layer,a,l):"tile"in t&&(h=t.tile);var c=(a-e)*map.tsize+r,u=(l-o)*map.tsize+n;0!==h&&this.ctx.drawImage(this.tileAtlas,(h-1)*map.tsize,0,map.tsize,map.tsize,Math.round(c),Math.round(u),map.tsize,map.tsize)}},Game._drawGrid=function(){for(var t,e,i=map.cols*map.tsize,o=map.rows*map.tsize,s=0;s<map.rows;s++)t=-this.camera.x,e=s*map.tsize-this.camera.y,this.ctx.beginPath(),this.ctx.moveTo(t,e),this.ctx.lineTo(i,e),this.ctx.stroke();for(var r=0;r<map.cols;r++)t=r*map.tsize-this.camera.x,e=-this.camera.y,this.ctx.beginPath(),this.ctx.moveTo(t,e),this.ctx.lineTo(t,o),this.ctx.stroke()},Hero.SPEED=192,Hero.EPS=4,Hero.prototype.update=function(t,e,i){var o=this._checkTarget();!1!==o&&this._activateTarget(o);var s=0,r=0;if(this.handMode)if(Keyboard.isDown(Keyboard.LEFT))s=-1;else if(Keyboard.isDown(Keyboard.RIGHT))s=1;else if(Keyboard.isDown(Keyboard.UP))r=-1;else if(Keyboard.isDown(Keyboard.DOWN))r=1;else{var n=getMousePosition();n&&(n.x-Hero.EPS>e?s=1:n.x+Hero.EPS<e&&(s=-1),n.y-Hero.EPS>i?r=1:n.y+Hero.EPS<i&&(r=-1))}else this.x<this.targets[this.closestTarget][0]+this.map.tsize/2-Hero.EPS&&(s=1),this.x>this.targets[this.closestTarget][0]+this.map.tsize/2+Hero.EPS&&(s=-1),this.y<this.targets[this.closestTarget][1]+this.map.tsize/2-Hero.EPS&&(r=1),this.y>this.targets[this.closestTarget][1]+this.map.tsize/2+Hero.EPS&&(r=-1),1===Math.abs(s)&&1===Math.abs(r)&&(s/=Math.sqrt(2),r/=Math.sqrt(2));this._move(t,s,r)},Hero.prototype._move=function(t,e,i){this.x+=e*Hero.SPEED*t,this.y+=i*Hero.SPEED*t,this._collide(e,i);var o=this.map.cols*this.map.tsize,s=this.map.rows*this.map.tsize;this.x=Math.max(0,Math.min(this.x,o)),this.y=Math.max(0,Math.min(this.y,s))},Hero.prototype._collide=function(t,e){var i,o,s=this.x-this.width/2,r=this.x+this.width/2-1,n=this.y-this.height/2,a=this.y+this.height/2-1;(this.map.isSolidTileAtXY(s,n)||this.map.isSolidTileAtXY(r,n)||this.map.isSolidTileAtXY(r,a)||this.map.isSolidTileAtXY(s,a))&&(0<e?(i=this.map.getRow(a),this.y=-this.height/2+this.map.getY(i)):e<0?(i=this.map.getRow(n),this.y=this.height/2+this.map.getY(i+1)):0<t?(o=this.map.getCol(r),this.x=-this.width/2+this.map.getX(o)):t<0&&(o=this.map.getCol(s),this.x=this.width/2+this.map.getX(o+1)))},Hero.prototype._getClosestTarget=function(){for(var t=!1,e=!1,i=0;i<this.targets.length;i++){var o=Math.pow(Math.abs(this.x-this.targets[i][0]),2)+Math.pow(Math.abs(this.y-this.targets[i][1]),2);(!1===e||o<t)&&(t=o,e=i)}return e},Hero.prototype._checkTarget=function(){if(!1===this.closestTarget)return!1;for(var t,e,i=0;i<this.targets.length;i++)if(t=Math.abs(this.x-this.targets[i][0]-this.map.tsize/2),e=Math.abs(this.y-this.targets[i][1]-this.map.tsize/2),Math.pow(t,2)+Math.pow(e,2)<=Math.pow(this.map.tsize/2,2))return i;return!1},Hero.prototype._activateTarget=function(t){this.map.removeTarget(this.targets[t][0],this.targets[t][1]),this.targets.splice(t,1);var e=this.map.createTarget();this.targets.push(e),this.closestTarget=this._getClosestTarget(),this.targetsAchieved++},Hero.prototype._bindHandModeBtn=function(){var e,i=document.querySelector(".js--game-hand-mode");e=this,i.addEventListener("click",function(t){t.preventDefault(),e.handMode?(e.handMode=!1,i.textContent="Ручной режим"):(e.handMode=!0,i.textContent="Автоматический режим")})};var Keyboard={LEFT:37,RIGHT:39,UP:38,DOWN:40,_keys:{},listenForEvents:function(t){window.addEventListener("keydown",this._onKeyDown.bind(this)),window.addEventListener("keyup",this._onKeyUp.bind(this)),t.forEach(function(t){this._keys[t]=!1}.bind(this))},_onKeyDown:function(t){var e=t.keyCode;e in this._keys&&(t.preventDefault(),this._keys[e]=!0)},_onKeyUp:function(t){var e=t.keyCode;e in this._keys&&(t.preventDefault(),this._keys[e]=!1)},isDown:function(t){if(!t in this._keys)throw new Error("Keycode "+t+" is not being listened to");return this._keys[t]}},Loader={images:{},loadImage:function(i,o){var s=new Image,t=new Promise(function(t,e){s.onload=function(){this.images[i]=s,t(s)}.bind(this),s.onerror=function(){e("Could not load image: "+o)}}.bind(this));return s.src=o,t},getImage:function(t){return t in this.images?this.images[t]:null}},map={cols:12,rows:12,tsize:64,layers:[[3,3,3,3,3,3,3,3,3,3,3,3,3,1,1,1,1,1,1,1,1,1,1,3,3,1,1,1,1,1,1,1,1,1,1,3,3,1,1,1,1,1,1,1,1,1,1,3,3,1,1,1,1,1,1,1,1,1,1,3,3,1,1,1,1,1,2,1,1,1,1,3,3,1,2,2,1,1,1,1,1,1,1,3,3,1,2,2,1,1,1,1,1,1,1,3,3,1,1,1,2,1,1,1,1,1,1,3,3,1,1,1,1,2,1,1,1,1,1,3,3,1,1,1,1,2,1,1,1,1,1,3,3,3,3,3,3,3,3,3,3,3,3,3],[4,3,3,3,3,3,3,3,3,3,3,4,4,0,0,0,0,0,0,0,0,0,0,4,4,0,0,0,0,0,0,0,0,0,0,4,4,0,0,5,0,0,0,0,0,5,0,4,4,0,0,0,0,0,0,0,0,0,0,4,4,0,0,0,0,0,0,0,0,0,0,4,4,0,0,0,0,0,0,0,0,0,0,4,4,0,0,0,0,0,0,0,0,0,0,4,4,0,0,0,0,0,0,0,0,0,0,4,4,0,0,0,0,0,0,0,0,0,0,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,3,3,3,3,3,3,3]],getTile:function(t,e,i){return this.layers[t][i*this.cols+e]},setTile:function(t,e,i,o){this.layers[t][i*this.cols+e]=o},isSolidTileAtXY:function(t,e){var s=Math.floor(t/this.tsize),r=Math.floor(e/this.tsize);return this.layers.reduce(function(t,e,i){var o=this.getTile(i,s,r);return t||3===o}.bind(this),!1)},getTargets:function(){for(var t=[],e=0;e<this.layers.length;e++)for(var i=0;i<this.cols;i++)for(var o=0;o<this.rows;o++){5===this.getTile(e,i,o)&&t.push([this.getX(i),this.getY(o)])}return t},removeTarget:function(t,e){for(var i=Math.floor(t/this.tsize),o=Math.floor(e/this.tsize),s=0;s<this.layers.length;s++){5===this.getTile(s,i,o)&&this.setTile(s,i,o,0)}},createTarget:function(){for(var t=[],e=0;e<this.layers[1].length;e++)0<=this.layers[1][e]&&this.layers[1][e]<=2&&0<=this.layers[0][e]&&this.layers[0][e]<=2&&t.push(e);var i=t[Math.floor(Math.random()*t.length)];this.layers[1][i]=5;var o=Math.floor(i/this.cols),s=i%this.cols;return[this.getX(s),this.getY(o)]},getCol:function(t){return Math.floor(t/this.tsize)},getRow:function(t){return Math.floor(t/this.tsize)},getX:function(t){return t*this.tsize},getY:function(t){return t*this.tsize}},mousePos=!1,canvas=document.querySelector("#canvas");function handleMouseMove(t){var e,i,o;null==(t=t||window.event).pageX&&null!=t.clientX&&(i=(e=t.target&&t.target.ownerDocument||document).documentElement,o=e.body,t.pageX=t.clientX+(i&&i.scrollLeft||o&&o.scrollLeft||0)-(i&&i.clientLeft||o&&o.clientLeft||0),t.pageY=t.clientY+(i&&i.scrollTop||o&&o.scrollTop||0)-(i&&i.clientTop||o&&o.clientTop||0)),mousePos={x:t.pageX,y:t.pageY}}function getCoords(t){var e=t.getBoundingClientRect();return{x:e.left+pageXOffset,y:e.top+pageYOffset,width:e.width,height:e.height}}function getMousePosition(){if(!mousePos)return!1;var t=getCoords(canvas);return mousePos.x>=t.x&&mousePos.x<=t.x+t.width&&mousePos.y>=t.y&&mousePos.y<=t.y+t.height&&{x:mousePos.x-t.x,y:mousePos.y-t.y}}document.onmousemove=handleMouseMove,window.onload=function(){var t=document.querySelector(".main-screen__canvas"),e=t.querySelector("#canvas");Game.run(t,e)},mainModule.init();